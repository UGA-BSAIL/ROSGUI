<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.7.3/nipplejs.js"></script>
    <script type="text/javascript" src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
    <script type="text/javascript"
            src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
    <script type="text/javascript" type="text/javascript">
        var myLatLng = {lat: 33.944371200000006, lng: -83.43388159999999};
        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: myLatLng,
                styles: [
                    {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
                    {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
                    {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
                    {
                        featureType: 'administrative.locality',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#d59563'}]
                    },
                    {
                        featureType: 'poi',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#d59563'}]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'geometry',
                        stylers: [{color: '#263c3f'}]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#6b9a76'}]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{color: '#38414e'}]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry.stroke',
                        stylers: [{color: '#212a37'}]
                    },
                    {
                        featureType: 'road',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#9ca5b3'}]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry',
                        stylers: [{color: '#746855'}]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry.stroke',
                        stylers: [{color: '#1f2835'}]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#f3d19c'}]
                    },
                    {
                        featureType: 'transit',
                        elementType: 'geometry',
                        stylers: [{color: '#2f3948'}]
                    },
                    {
                        featureType: 'transit.station',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#d59563'}]
                    },
                    {
                        featureType: 'water',
                        elementType: 'geometry',
                        stylers: [{color: '#17263c'}]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.fill',
                        stylers: [{color: '#515c6d'}]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.stroke',
                        stylers: [{color: '#17263c'}]
                    }

                ]
            });
            var marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                title: 'Jackal'
            });

        }

        var ros = new ROSLIB.Ros({
            url: 'ws://rosbox.local:9090'
        });

        function checkAgain() {
            var gps_listener = new ROSLIB.Topic({
                ros: ros,
                name: '/navsat/fix',
                messageType: 'sensor_msgs/NavSatFix'
            });


            gps_listener.subscribe(function (message) {
                console.log('Longitude: ' + message.longitude + ', Latitude: ' + message.latitude);
                myLatLng = {lat: message.latitude, lng: message.longitude};
                document.getElementById("lat").setAttribute("value", message.latitude);
                document.getElementById("lon").setAttribute("value", message.longitude);
                initMap();
                gps_listener.unsubscribe();
            });
            myLatLng = {lat: message.latitude, lng: message.longitude};
            return myLatLng;
        }


        ros.on('connection', function () {
            document.getElementById("status").innerHTML = "<span style='color:#66ff33;'>Active</span>";
        });

        ros.on('error', function (error) {
            document.getElementById("status").innerHTML = "<span style='color:red;'>Error</span>";
        });

        ros.on('close', function () {
            document.getElementById("status").innerHTML = "<span style='color:red;'>Inactive</span>";
        });

        ros.on('latitude', function () {
            document.getElementById("lat").innerHTML = message.latitude;
        });

        ros.on('longitude', function () {
            document.getElementById("log").innerHTML = message.longitude;
        });


        var txt_listener = new ROSLIB.Topic({
            ros: ros,
            name: '/txt_msg',
            messageType: 'std_msgs/String'
        });


        txt_listener.subscribe(function (m) {
            document.getElementById("msg").innerHTML = m.data;
            move(1, 0);
        });

        var cmd_vel_listener = new ROSLIB.Topic({
            ros: ros,
            name: '/cmd_vel',
            messageType: 'geometry_msgs/Twist'
        });


        move = function (linear, angular) {
            var twist = new ROSLIB.Message({
                linear: {
                    x: linear,
                    y: 0,
                    z: 0
                },
                angular: {
                    x: 0,
                    y: 0,
                    z: angular
                }
            });
            cmd_vel_listener.publish(twist);
        }

        createJoystick = function () {
            var options = {
                zone: document.getElementById('zone_joystick'),
                threshold: 0.1,
                position: {left: 50 + '%'},
                mode: 'static',
                size: 150,
                color: '#000000',
            };

            manager = nipplejs.create(options);

            linear_speed = 0;
            angular_speed = 0;


            self.manager.on('start', function (event, nipple) {
                console.log("Movement start");
            });

            self.manager.on('move', function (event, nipple) {
                console.log("Moving");
            });

            self.manager.on('end', function () {
                console.log("Movement end");
            });

            /* Spawn timer that will call the move function
          *  with the linear_speed and angular_speed at a
          *  a rate of 25 Hz.
          */
            manager.on('start', function (event, nipple) {
                timer = setInterval(function () {
                    move(linear_speed, angular_speed);
                }, 25);
            });

            /* Clears the timer and stops publishing desired velocity
            *  at 25 Hz and send out a (0,0) velocity command.
            */
            manager.on('end', function () {
                if (timer) {
                    clearInterval(timer);
                }
                self.move(0, 0);
            });

            /* Convert the distance and angle to linear velocity and
            *  angular velocity (rotation around the z-axis of robot)
            */
            manager.on('move', function (event, nipple) {
                max_linear = 5.0;
                max_angular = 2.0;
                max_distance = 75.0;
                linear_speed = Math.sin(nipple.angle.radian) * max_linear * nipple.distance / max_distance;
                angular_speed = -Math.cos(nipple.angle.radian) * max_angular * nipple.distance / max_distance;
            });
        }

        window.onload = function () {
            createJoystick();
        }
    </script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        header {
            background-color: #242734;
            padding: 30px;
            text-align: center;
            font-size: 35px;
            color: white;
        }

        body {
            background-color: #181B26;
        }

        input {
            background-color: #636679;
            color: white;
            border: none;
        }

        div.widel {
            width: 400px;
            height: 255px;
            float: left;
            margin-left: 75px;
            margin-top: 50px;
            background: #242734;
        }

        div.wider {
            width: 1324px;
            height: 755px;
            float: right;
            margin-right: 75px;
            margin-top: 50px;

            background: #242734;
        }

        div.parent {
            width: 100%;
            height: 100%;
        }

        button {
            background-color: #404060; /* Grey */
            border: none;
            border-radius: 8px;
            color: grey;
            width: 180px;
            height: 60px;
            margin-left: 15px;
            margin-top: 28px;
            text-align: center;

        }

        button:hover {
            background-color: grey;
            color: black;
        }


    </style>
</head>

<body>
<header>
    <h5 style="font-family: Montserrat, serif; margin: 14px;"><b> H U S K Y &nbsp; &nbsp; A 2 0 0</b></h5>
    <h6 style="font-family: Montserrat, serif; margin: 14px;"><small>B&nbsp;S&nbsp;A&nbsp;I&nbsp;L&nbsp; &nbsp; R&nbsp;O&nbsp;B&nbsp;O&nbsp;T&nbsp;I&nbsp;C&nbsp;S</small>
    </h6>
</header>
<div class="parent">
    <div class="widel">
        <p style="font-family: Montserrat, serif; color: white; margin-left: 25px;">Connection Status: <span id="status"
                                                                                                             style="margin-left: 100px;"></span>
        </p>
        <p style="font-family: Montserrat, serif; color: white; margin-left: 25px;">Last Message Received: <span
                id="msg"></span></p>
        <p style="font-family: Montserrat, serif; color: white; margin-left: 25px;">Latitude: <input id="lat"
                                                                                                     name="Latitude"
                                                                                                     type="text"
                                                                                                     style="margin-right: 25px; margin-left: 25px;"
                                                                                                     readonly/></p>
        <p style="font-family: Montserrat, serif; color: white; margin-left: 25px;">Longtitude: <input id="lon"
                                                                                                       name="Longitude"
                                                                                                       type="text"
                                                                                                       style="margin-right: 25px; margin-left: 2px;"
                                                                                                       readonly/></p>
        <button style="font-family: Montserrat, serif; margin-left: 25px;" name="button" onclick="checkAgain()">Update
            Map
        </button>
    </div>
    <div class="wider">
        <div id="map"></div>

    </div>
</div>
<div id="zone_joystick" style="position: relative;"></div>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAimaemR7bxcifcsEirzZODpCbpafx0yK0&callback=initMap">
</script>

</body>
</html>